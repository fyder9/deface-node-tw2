<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DeFace</title>

    <script defer src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script defer src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="styles/home-style.css" />


</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useMemo, useRef, useState, useEffect } = React;

        function App() {
            // states: idle -> selected -> processing -> done
            const [state, setState] = useState("idle");
            const [progress, setProgress] = useState(0);
            const [file, setFile] = useState(null);
            const [resultUrl, setResultUrl] = useState("");
            ///////
            const [menuOpen, setMenuOpen] = useState(false);
            const [outputs, setOutputs] = useState([]);
            const [loadingOutputs, setLoadingOutputs] = useState(false);
            const [outputsError, setOutputsError] = useState(null);
            const OUTPUTS_ENDPOINT = "/outputs";
            const DELETE_OUTPUT_ENDPOINT = "/delete-output";
            const DOWNLOAD_OUTPUT_ENDPOINT = "/download-output";
            ///////

            const inputRef = useRef(null);

            const hasFile = useMemo(() => !!file, [file]);

            useEffect(() => {
                if (state !== "processing") return;

                const es = new EventSource("/progress");

                es.onmessage = (event) => {
                    const value = Number(event.data);
                    if (!isNaN(value)) {
                        setProgress(value);
                    }
                };

                return () => {
                    es.close();
                };
            }, [state]);

            function openPicker() {
                inputRef.current?.click();
            }

            function onPick(e) {
                const f = e.target.files?.[0];
                if (!f) return;
                setFile(f);
                setState("selected");
            }

            function removeFile() {
                setFile(null);
                setState("idle");
                if (inputRef.current) inputRef.current.value = "";
            }

            async function startProcess() {
                if (!file) return;
                setState("processing");

                const form = new FormData();
                form.append("video", file);
                try {
                    const res = await fetch("/upload", {
                        method: "POST",
                        body: form
                    });
                    const endSignal = await res.json();
                    if (endSignal.ok != true) throw new Error("Upload failed");
                    setResultUrl(endSignal.url);
                    setState("done");
                }
                catch (e) {
                    alert("Error during l'upload/processing.");
                    setState("selected");
                    return;
                }

            }

            function resetToUpload() {
                openPicker();
            }

            function downloadResult() {
                if (!resultUrl) return;
                window.location.href = resultUrl;
            }

            async function copyToClipboard() {
                if (!resultUrl) return;
                const fullUrl = window.location.origin + resultUrl;
                try {
                    await navigator.clipboard.writeText(fullUrl);
                    alert("Copiato negli appunti!");
                } catch (e) {
                    alert("Clipboard non disponibile (http/permessi).");
                }
            }
            async function loadOutputsDirectory() {
                setLoadingOutputs(true);
                setOutputsError("");
                try {
                    const res = await fetch(OUTPUTS_ENDPOINT);
                    const data = await res.json();
                    console.log(data);
                    if (!res.ok || data.ok !== true) throw new Error(data.message || "Errore lista outputs");
                    setOutputs(data.files.map(f => f.filename));
                } catch (e) {
                    setOutputsError(e.message);
                } finally {
                    setLoadingOutputs(false);
                }
            }

            function openMenu() {
                if (!menuOpen) {
                    setMenuOpen(true);
                    loadOutputsDirectory();
                }
            }
            function closeMenu() {
                setMenuOpen(false);
            }

            return (
                <div className="stage">
                    <div className="card">
                        <button className="menuBtn" onClick={openMenu} aria-label="Apri menu">
                            ☰
                        </button>
                        {menuOpen && (
                            <>
                                <div className="backdrop" onClick={closeMenu} />
                                <aside className="sidebar">
                                    <div className="sidebarHeader">
                                        <div className="sidebarTitle">Menu</div>
                                        <button className="sidebarClose" onClick={closeMenu} aria-label="Chiudi menu">✕</button>
                                    </div>

                                    <div className="sidebarSection">
                                        <div className="sidebarSectionTitle">Outputs</div>

                                        {loadingOutputs && <div className="sidebarHint">Caricamento...</div>}
                                        {outputsError && <div className="sidebarError">{outputsError}</div>}

                                        {!loadingOutputs && !outputsError && outputs.length === 0 && (
                                            <div className="sidebarHint">Nessun file in outputs.</div>
                                        )}

                                        <div className="fileList">
                                            {outputs.map((name) => (
                                                <a
                                                    key={name}
                                                    className="fileItem"
                                                    href={`${DOWNLOAD_OUTPUT_ENDPOINT}?name=${encodeURIComponent(name)}`}
                                                >
                                                    {name}
                                                </a>
                                            ))}
                                        </div>
                                    </div>
                                </aside>
                            </>
                        )}
                        <div className="content">
                            <div className="brand fadeUp">
                                <div>DeFace</div>
                                <img src="/assets/logo-smile.png" alt="logo" />
                            </div>

                            {/* input hidden */}
                            <input
                                ref={inputRef}
                                type="file"
                                accept="video/*"
                                style={{ display: "none" }}
                                onChange={onPick}
                            />

                            {/* SCENE */}
                            <div className="swap">
                                {state === "idle" && (
                                    <div className="stateWrap fadeUp">
                                        <button className="uploadBtn" onClick={openPicker}>
                                            <span>carica video</span>
                                            <span className="plusBox">
                                                <img src="/assets/icon-plus.png" alt="+" />
                                            </span>
                                        </button>
                                    </div>
                                )}

                                {state === "selected" && (
                                    <div className="stateWrap fadeUp">
                                        <div className="row">
                                            <div className="pill">
                                                <span>video caricato</span>
                                                <img className="thumb" src="/assets/thumb.png" alt="thumb" />
                                            </div>
                                            <button className="btnIcon" onClick={removeFile} aria-label="Rimuovi video">
                                                <img src="/assets/icon-close.png" alt="X" />
                                            </button>
                                        </div>

                                        <button className="btnBig" onClick={startProcess}>
                                            BLUR
                                        </button>
                                    </div>
                                )}

                                {state === "processing" && (
                                    <div className="stateWrap fadeUp">
                                        <img
                                            className={`avatar ${state === "processing" ? "processing" : ""}`}
                                            src="/assets/avatar.png"
                                            alt="avatar"
                                        />
                                        <div
                                            className="progressShell"
                                            aria-label="Caricamento in corso"
                                        ><span className="progressText">{progress}%</span></div>
                                    </div>
                                )}

                                {state === "done" && (
                                    <div className="stateWrap fadeUp">
                                        <button className="uploadBtn" onClick={resetToUpload}>
                                            <span>carica video</span>
                                            <span className="plusBox">
                                                <img src="/assets/icon-plus.png" alt="+" />
                                            </span>
                                        </button>

                                        <div className="row" style={{ marginTop: 6 }}>
                                            <button className="downloadPill" onClick={downloadResult}>
                                                <span>SCARICA</span>
                                                <span className="circleIcon" aria-hidden="true">
                                                    <img src="/assets/icon-download.png" alt="" />
                                                </span>
                                            </button>

                                            <button className="circleBtn" onClick={copyToClipboard} aria-label="Copia">
                                                <img src="/assets/icon-copy.png" alt="copy" />
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById("root")).render(<App />);

    </script>
</body>

</html>